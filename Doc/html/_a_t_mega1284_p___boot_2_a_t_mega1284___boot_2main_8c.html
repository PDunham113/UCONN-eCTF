<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UConn Mitre eCTF: ATMega1284P_Boot/ATMega1284_Boot/main.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">UConn Mitre eCTF
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_0b06bee15cc5fccdb3c2c35944938f24.html">ATMega1284P_Boot</a></li><li class="navelem"><a class="el" href="dir_935e96d6e2feabcb9e0ceea016a3be1d.html">ATMega1284_Boot</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">main.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;avr/io.h&gt;</code><br />
<code>#include &lt;avr/boot.h&gt;</code><br />
<code>#include &lt;avr/wdt.h&gt;</code><br />
<code>#include &lt;avr/interrupt.h&gt;</code><br />
<code>#include &lt;avr/pgmspace.h&gt;</code><br />
<code>#include &quot;<a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2uart_8h_source.html">uart.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2_a_e_s__lib_8h_source.html">AES_lib.h</a>&quot;</code><br />
<code>#include &quot;secret_build_output.txt&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for main.c:</div>
<div class="dyncontent">
<div class="center"><img src="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c__incl.png" border="0" usemap="#_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c" alt=""/></div>
<!-- MAP 0 -->
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a43bafb28b29491ec7f871319b5a3b2f8"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a43bafb28b29491ec7f871319b5a3b2f8">F_CPU</a>&#160;&#160;&#160;7300000UL</td></tr>
<tr class="separator:a43bafb28b29491ec7f871319b5a3b2f8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a62634036639f88eece6fbf226b45f84b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a62634036639f88eece6fbf226b45f84b">BAUD</a>&#160;&#160;&#160;115200UL</td></tr>
<tr class="separator:a62634036639f88eece6fbf226b45f84b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a16d349d854d023bed03d4af1f959258b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a16d349d854d023bed03d4af1f959258b">UPDATE_PIN</a>&#160;&#160;&#160;PINB2</td></tr>
<tr class="separator:a16d349d854d023bed03d4af1f959258b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a629eca34f36fcebadd517638668edc5b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a629eca34f36fcebadd517638668edc5b">READBACK_PIN</a>&#160;&#160;&#160;PINB3</td></tr>
<tr class="separator:a629eca34f36fcebadd517638668edc5b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adb5b0e47cb4aa23f0296ea2929cb8965"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#adb5b0e47cb4aa23f0296ea2929cb8965">CONFIGURE_PIN</a>&#160;&#160;&#160;PINB4</td></tr>
<tr class="separator:adb5b0e47cb4aa23f0296ea2929cb8965"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0b29e6d93aad7f8976b56e2e6dafa8a1"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a0b29e6d93aad7f8976b56e2e6dafa8a1">RAND_CLOCK_SWITCH</a>&#160;&#160;&#160;10</td></tr>
<tr class="separator:a0b29e6d93aad7f8976b56e2e6dafa8a1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6f6489887e08bff4887d0bc5dcf214d8"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a6f6489887e08bff4887d0bc5dcf214d8">ACK</a>&#160;&#160;&#160;((unsigned char)0x06)</td></tr>
<tr class="separator:a6f6489887e08bff4887d0bc5dcf214d8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a958518a45b12053ae33606ee7cb68a55"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a958518a45b12053ae33606ee7cb68a55">NACK</a>&#160;&#160;&#160;((unsigned char)0x15)</td></tr>
<tr class="separator:a958518a45b12053ae33606ee7cb68a55"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad51ded0bbd705f02f73fc60c0b721ced"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#ad51ded0bbd705f02f73fc60c0b721ced">BLOCK_SIZE</a>&#160;&#160;&#160;16UL</td></tr>
<tr class="separator:ad51ded0bbd705f02f73fc60c0b721ced"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2d996237e082b78b41771b5aa1a6eae1"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>&#160;&#160;&#160;32UL</td></tr>
<tr class="separator:a2d996237e082b78b41771b5aa1a6eae1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6bfdf0e01e9d3de942e38ba284d8ada3"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a6bfdf0e01e9d3de942e38ba284d8ada3">READBACK_PASSWORD_SIZE</a>&#160;&#160;&#160;24UL</td></tr>
<tr class="separator:a6bfdf0e01e9d3de942e38ba284d8ada3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa86726c202d06362938bb5f240af754b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#aa86726c202d06362938bb5f240af754b">BOOTLDR_SIZE</a>&#160;&#160;&#160;8192UL</td></tr>
<tr class="separator:aa86726c202d06362938bb5f240af754b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae3ef7bba113f663df6996f286b632a3f"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#ae3ef7bba113f663df6996f286b632a3f">EEPROM_SIZE</a>&#160;&#160;&#160;4096UL</td></tr>
<tr class="separator:ae3ef7bba113f663df6996f286b632a3f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3f2bd9d166029160170f5a854aabdb06"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a3f2bd9d166029160170f5a854aabdb06">LOAD_FIRMWARE_PAGE_NUMBER</a>&#160;&#160;&#160;126UL</td></tr>
<tr class="separator:a3f2bd9d166029160170f5a854aabdb06"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7a83bed0a2957de15d4d53c0fdda30c6"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a7a83bed0a2957de15d4d53c0fdda30c6">READBACK_REQUEST_SIZE</a>&#160;&#160;&#160;48UL</td></tr>
<tr class="separator:a7a83bed0a2957de15d4d53c0fdda30c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5673c89974df0bf43ae1875b90770753"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a5673c89974df0bf43ae1875b90770753">APPLICATION_SECTION</a>&#160;&#160;&#160;0UL * LOAD_FIRMWARE_PAGE_NUMBER * SPM_PAGESIZE</td></tr>
<tr class="separator:a5673c89974df0bf43ae1875b90770753"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac72f8903909f218f65f1ed4c71672c8b"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#ac72f8903909f218f65f1ed4c71672c8b">MESSAGE_SECTION</a>&#160;&#160;&#160;1UL * (LOAD_FIRMWARE_PAGE_NUMBER - 6) * SPM_PAGESIZE</td></tr>
<tr class="separator:ac72f8903909f218f65f1ed4c71672c8b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac7411bb1c1fe4795680521813de49b83"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#ac7411bb1c1fe4795680521813de49b83">ENCRYPTED_SECTION</a>&#160;&#160;&#160;1UL * LOAD_FIRMWARE_PAGE_NUMBER * SPM_PAGESIZE</td></tr>
<tr class="separator:ac7411bb1c1fe4795680521813de49b83"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aefc050cbb6b5bd75ca2294fbca6b51a1"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#aefc050cbb6b5bd75ca2294fbca6b51a1">DECRYPTED_SECTION</a>&#160;&#160;&#160;2UL * LOAD_FIRMWARE_PAGE_NUMBER * SPM_PAGESIZE</td></tr>
<tr class="separator:aefc050cbb6b5bd75ca2294fbca6b51a1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9f8baeb83b25f1f50df86b9ca7979a84"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a9f8baeb83b25f1f50df86b9ca7979a84">BOOTLDR_SECTION</a>&#160;&#160;&#160;480UL * SPM_PAGESIZE</td></tr>
<tr class="separator:a9f8baeb83b25f1f50df86b9ca7979a84"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2bbf7f4d4680bb65730e1cce022349ee"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a2bbf7f4d4680bb65730e1cce022349ee">FIRM_HASH_SECTION</a>&#160;&#160;&#160;479UL * SPM_PAGESIZE</td></tr>
<tr class="separator:a2bbf7f4d4680bb65730e1cce022349ee"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abbdb10a4e65490e6532b4869a0cda533"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#abbdb10a4e65490e6532b4869a0cda533">BOOT_HASH_SECTION</a>&#160;&#160;&#160;511UL * SPM_PAGESIZE</td></tr>
<tr class="separator:abbdb10a4e65490e6532b4869a0cda533"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ab7210aaba738ad94e5fd964a5570cee6"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#ab7210aaba738ad94e5fd964a5570cee6">initTimer0</a> (void)</td></tr>
<tr class="memdesc:ab7210aaba738ad94e5fd964a5570cee6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize Timer0 for clock switching.  <a href="#ab7210aaba738ad94e5fd964a5570cee6">More...</a><br /></td></tr>
<tr class="separator:ab7210aaba738ad94e5fd964a5570cee6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3196fd27b969056c23b17850d0839e85"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a3196fd27b969056c23b17850d0839e85">enableClockSwitching</a> (void)</td></tr>
<tr class="memdesc:a3196fd27b969056c23b17850d0839e85"><td class="mdescLeft">&#160;</td><td class="mdescRight">Starts Timer0, enabling Clock Switching.  <a href="#a3196fd27b969056c23b17850d0839e85">More...</a><br /></td></tr>
<tr class="separator:a3196fd27b969056c23b17850d0839e85"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a86b1b361f8d4d2fe6b8b428feba54867"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a86b1b361f8d4d2fe6b8b428feba54867">disableClockSwitching</a> (void)</td></tr>
<tr class="memdesc:a86b1b361f8d4d2fe6b8b428feba54867"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stops Timer0, disabling Clock Switching.  <a href="#a86b1b361f8d4d2fe6b8b428feba54867">More...</a><br /></td></tr>
<tr class="separator:a86b1b361f8d4d2fe6b8b428feba54867"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9401b6b502308eaaa5813082af1c3046"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a9401b6b502308eaaa5813082af1c3046">load_firmware</a> (void)</td></tr>
<tr class="memdesc:a9401b6b502308eaaa5813082af1c3046"><td class="mdescLeft">&#160;</td><td class="mdescRight">Loads a new firmware image and release message.  <a href="#a9401b6b502308eaaa5813082af1c3046">More...</a><br /></td></tr>
<tr class="separator:a9401b6b502308eaaa5813082af1c3046"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aadd0c9265bc34afbab613a5935d63281"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#aadd0c9265bc34afbab613a5935d63281">boot_firmware</a> (void)</td></tr>
<tr class="memdesc:aadd0c9265bc34afbab613a5935d63281"><td class="mdescLeft">&#160;</td><td class="mdescRight">Ensures the firmware is loaded correctly and boots it up.  <a href="#aadd0c9265bc34afbab613a5935d63281">More...</a><br /></td></tr>
<tr class="separator:aadd0c9265bc34afbab613a5935d63281"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5d4adc248ad2605b7c045108c6a48b1b"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a5d4adc248ad2605b7c045108c6a48b1b">readback</a> (void)</td></tr>
<tr class="memdesc:a5d4adc248ad2605b7c045108c6a48b1b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Interfaces with host readback tool.  <a href="#a5d4adc248ad2605b7c045108c6a48b1b">More...</a><br /></td></tr>
<tr class="separator:a5d4adc248ad2605b7c045108c6a48b1b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a10ff4a55a184a56510f959b90ddb74e4"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a10ff4a55a184a56510f959b90ddb74e4">configure</a> (void)</td></tr>
<tr class="memdesc:a10ff4a55a184a56510f959b90ddb74e4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Interfaces with host configure tool.  <a href="#a10ff4a55a184a56510f959b90ddb74e4">More...</a><br /></td></tr>
<tr class="separator:a10ff4a55a184a56510f959b90ddb74e4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a16ce9e8fa9487889a54985d19a3fe160"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a16ce9e8fa9487889a54985d19a3fe160">calcHash</a> (uint8_t *key, uint16_t startPage, uint16_t endPage, uint8_t *hash, uint8_t EEFlag)</td></tr>
<tr class="memdesc:a16ce9e8fa9487889a54985d19a3fe160"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates a hash of a memory section.  <a href="#a16ce9e8fa9487889a54985d19a3fe160">More...</a><br /></td></tr>
<tr class="separator:a16ce9e8fa9487889a54985d19a3fe160"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2695b90a2a64b6fe11e14c1e2d13f26f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a2695b90a2a64b6fe11e14c1e2d13f26f">program_flash</a> (uint32_t page_address, unsigned char *data)</td></tr>
<tr class="memdesc:a2695b90a2a64b6fe11e14c1e2d13f26f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Programs a page of ATMega1284P flash memory.  <a href="#a2695b90a2a64b6fe11e14c1e2d13f26f">More...</a><br /></td></tr>
<tr class="separator:a2695b90a2a64b6fe11e14c1e2d13f26f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a840291bc02cba5474a4cb46a9b9566fe"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main</a> (void)</td></tr>
<tr class="separator:a840291bc02cba5474a4cb46a9b9566fe"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a4710eb249c76fbcee86e3b3ea93f7ea7"><td class="memItemLeft" align="right" valign="top">uint16_t fw_version&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a4710eb249c76fbcee86e3b3ea93f7ea7">EEMEM</a> = 1</td></tr>
<tr class="separator:a4710eb249c76fbcee86e3b3ea93f7ea7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1c67bcd43e103c8093bb6036690ab2e3"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a1c67bcd43e103c8093bb6036690ab2e3">hashKey</a> [<a class="el" href="bootloader_2main_8c.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>] = H_KEY</td></tr>
<tr class="separator:a1c67bcd43e103c8093bb6036690ab2e3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a36bf49f5e29276a4e9e96bf39a621f80"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a36bf49f5e29276a4e9e96bf39a621f80">readbackHashKey</a> [<a class="el" href="bootloader_2main_8c.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>] = RBH_KEY</td></tr>
<tr class="separator:a36bf49f5e29276a4e9e96bf39a621f80"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3604d93cc7032be26dcca6e694afef50"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a3604d93cc7032be26dcca6e694afef50">firmwareKey</a> [<a class="el" href="bootloader_2main_8c.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>] = FW_KEY</td></tr>
<tr class="separator:a3604d93cc7032be26dcca6e694afef50"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab712a58833cf27f708f308e3e491a3e7"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#ab712a58833cf27f708f308e3e491a3e7">readbackKey</a> [<a class="el" href="bootloader_2main_8c.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>] = RB_KEY</td></tr>
<tr class="separator:ab712a58833cf27f708f308e3e491a3e7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac23353dfc159499579eee2c03444f504"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#ac23353dfc159499579eee2c03444f504">firmwareIV</a> [<a class="el" href="bootloader_2main_8c.html#ad51ded0bbd705f02f73fc60c0b721ced">BLOCK_SIZE</a>] = FW_IV</td></tr>
<tr class="separator:ac23353dfc159499579eee2c03444f504"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1b8a8d208ede5763090cb2498cb954de"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a1b8a8d208ede5763090cb2498cb954de">readbackIV</a> [<a class="el" href="bootloader_2main_8c.html#ad51ded0bbd705f02f73fc60c0b721ced">BLOCK_SIZE</a>] = RB_IV</td></tr>
<tr class="separator:a1b8a8d208ede5763090cb2498cb954de"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a68fe00d921fd371e6ed4b5e5c9350fd6"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a68fe00d921fd371e6ed4b5e5c9350fd6">readbackPassword</a> [<a class="el" href="bootloader_2main_8c.html#a6bfdf0e01e9d3de942e38ba284d8ada3">READBACK_PASSWORD_SIZE</a>] = RB_PW</td></tr>
<tr class="separator:a68fe00d921fd371e6ed4b5e5c9350fd6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a6f6489887e08bff4887d0bc5dcf214d8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6f6489887e08bff4887d0bc5dcf214d8">&#9670;&nbsp;</a></span>ACK</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ACK&#160;&#160;&#160;((unsigned char)0x06)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a5673c89974df0bf43ae1875b90770753"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5673c89974df0bf43ae1875b90770753">&#9670;&nbsp;</a></span>APPLICATION_SECTION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define APPLICATION_SECTION&#160;&#160;&#160;0UL * LOAD_FIRMWARE_PAGE_NUMBER * SPM_PAGESIZE</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a62634036639f88eece6fbf226b45f84b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a62634036639f88eece6fbf226b45f84b">&#9670;&nbsp;</a></span>BAUD</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BAUD&#160;&#160;&#160;115200UL</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ad51ded0bbd705f02f73fc60c0b721ced"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad51ded0bbd705f02f73fc60c0b721ced">&#9670;&nbsp;</a></span>BLOCK_SIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BLOCK_SIZE&#160;&#160;&#160;16UL</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="abbdb10a4e65490e6532b4869a0cda533"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abbdb10a4e65490e6532b4869a0cda533">&#9670;&nbsp;</a></span>BOOT_HASH_SECTION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BOOT_HASH_SECTION&#160;&#160;&#160;511UL * SPM_PAGESIZE</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a9f8baeb83b25f1f50df86b9ca7979a84"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9f8baeb83b25f1f50df86b9ca7979a84">&#9670;&nbsp;</a></span>BOOTLDR_SECTION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BOOTLDR_SECTION&#160;&#160;&#160;480UL * SPM_PAGESIZE</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aa86726c202d06362938bb5f240af754b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa86726c202d06362938bb5f240af754b">&#9670;&nbsp;</a></span>BOOTLDR_SIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BOOTLDR_SIZE&#160;&#160;&#160;8192UL</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="adb5b0e47cb4aa23f0296ea2929cb8965"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adb5b0e47cb4aa23f0296ea2929cb8965">&#9670;&nbsp;</a></span>CONFIGURE_PIN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CONFIGURE_PIN&#160;&#160;&#160;PINB4</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="aefc050cbb6b5bd75ca2294fbca6b51a1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aefc050cbb6b5bd75ca2294fbca6b51a1">&#9670;&nbsp;</a></span>DECRYPTED_SECTION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DECRYPTED_SECTION&#160;&#160;&#160;2UL * LOAD_FIRMWARE_PAGE_NUMBER * SPM_PAGESIZE</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ae3ef7bba113f663df6996f286b632a3f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae3ef7bba113f663df6996f286b632a3f">&#9670;&nbsp;</a></span>EEPROM_SIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define EEPROM_SIZE&#160;&#160;&#160;4096UL</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ac7411bb1c1fe4795680521813de49b83"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac7411bb1c1fe4795680521813de49b83">&#9670;&nbsp;</a></span>ENCRYPTED_SECTION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ENCRYPTED_SECTION&#160;&#160;&#160;1UL * LOAD_FIRMWARE_PAGE_NUMBER * SPM_PAGESIZE</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a43bafb28b29491ec7f871319b5a3b2f8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a43bafb28b29491ec7f871319b5a3b2f8">&#9670;&nbsp;</a></span>F_CPU</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define F_CPU&#160;&#160;&#160;7300000UL</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>bootloader.c</p>
<p>If Port B Pin 2 (PB2 on the ProtoStack board) is pulled to ground the bootloader will wait for data to appear on UART1 (which will be interpreted as an updated firmware package).</p>
<p>If the PB2 pin is NOT pulled to ground, but Port B Pin 3 (PB3 on the ProtoStack board) is pulled to ground, then the bootloader will enter flash memory readback mode.</p>
<p>If the PB3 pin is NOT pulled to ground, but Port B Pin 4 (PB4 on the ProtoStack board) is pulled to ground, then the bootloader will enter bootloader configure mode.</p>
<p>If NEITHER of these pins are pulled to ground, then the bootloader will execute the application from flash.</p>
<p>The load_firmware function details the structure of the firmware upload messages.</p>
<p>The readback function details the structure of the readback request messages.</p>
<p>See <a class="el" href="_a_t_mega1284_p___boot_2_a_t_mega1284___boot_2main_8c.html#a2695b90a2a64b6fe11e14c1e2d13f26f" title="Programs a page of ATMega1284P flash memory. ">program_flash()</a> for information on the process of programming the flash memory. Note that if no data is received after 2 seconds, the bootloader will time out and reset. </p>

</div>
</div>
<a id="a2bbf7f4d4680bb65730e1cce022349ee"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2bbf7f4d4680bb65730e1cce022349ee">&#9670;&nbsp;</a></span>FIRM_HASH_SECTION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define FIRM_HASH_SECTION&#160;&#160;&#160;479UL * SPM_PAGESIZE</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a2d996237e082b78b41771b5aa1a6eae1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2d996237e082b78b41771b5aa1a6eae1">&#9670;&nbsp;</a></span>KEY_SIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define KEY_SIZE&#160;&#160;&#160;32UL</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a3f2bd9d166029160170f5a854aabdb06"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3f2bd9d166029160170f5a854aabdb06">&#9670;&nbsp;</a></span>LOAD_FIRMWARE_PAGE_NUMBER</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOAD_FIRMWARE_PAGE_NUMBER&#160;&#160;&#160;126UL</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ac72f8903909f218f65f1ed4c71672c8b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac72f8903909f218f65f1ed4c71672c8b">&#9670;&nbsp;</a></span>MESSAGE_SECTION</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MESSAGE_SECTION&#160;&#160;&#160;1UL * (LOAD_FIRMWARE_PAGE_NUMBER - 6) * SPM_PAGESIZE</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a958518a45b12053ae33606ee7cb68a55"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a958518a45b12053ae33606ee7cb68a55">&#9670;&nbsp;</a></span>NACK</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NACK&#160;&#160;&#160;((unsigned char)0x15)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a0b29e6d93aad7f8976b56e2e6dafa8a1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0b29e6d93aad7f8976b56e2e6dafa8a1">&#9670;&nbsp;</a></span>RAND_CLOCK_SWITCH</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define RAND_CLOCK_SWITCH&#160;&#160;&#160;10</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a6bfdf0e01e9d3de942e38ba284d8ada3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6bfdf0e01e9d3de942e38ba284d8ada3">&#9670;&nbsp;</a></span>READBACK_PASSWORD_SIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define READBACK_PASSWORD_SIZE&#160;&#160;&#160;24UL</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a629eca34f36fcebadd517638668edc5b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a629eca34f36fcebadd517638668edc5b">&#9670;&nbsp;</a></span>READBACK_PIN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define READBACK_PIN&#160;&#160;&#160;PINB3</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a7a83bed0a2957de15d4d53c0fdda30c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7a83bed0a2957de15d4d53c0fdda30c6">&#9670;&nbsp;</a></span>READBACK_REQUEST_SIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define READBACK_REQUEST_SIZE&#160;&#160;&#160;48UL</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a16d349d854d023bed03d4af1f959258b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a16d349d854d023bed03d4af1f959258b">&#9670;&nbsp;</a></span>UPDATE_PIN</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define UPDATE_PIN&#160;&#160;&#160;PINB2</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="aadd0c9265bc34afbab613a5935d63281"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aadd0c9265bc34afbab613a5935d63281">&#9670;&nbsp;</a></span>boot_firmware()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void boot_firmware </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Ensures the firmware is loaded correctly and boots it up. </p>
<p>This function calculates the hash of the firmware section and compares it to the one currently stored.</p>
<p>HASH CORRECT - The function prints a release message if available, and boots. The Watchdog Timer is disabled before boot.</p>
<p>HASH INCORRECT - The function indicates firmware error and resets. </p>
<ul>
<li>CHECK HASH */ </li>
</ul>

</div>
</div>
<a id="a16ce9e8fa9487889a54985d19a3fe160"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a16ce9e8fa9487889a54985d19a3fe160">&#9670;&nbsp;</a></span>calcHash()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calcHash </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>startPage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>endPage</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>hash</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>EEFlag</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates a hash of a memory section. </p>
<p>This function calculates the CBC-MAC hash of a section in flash or in EEPROM. The section is indexed by pages, where 1 page = 256 bytes. Both EEPROM and FLASH are indexed through the same method. The final byte is used as a flag to indicate which region of memory is being hashed. </p><pre class="fragment">0 - Hash Flash  Memory

1 - Hash EEPROM Memory
</pre><p>The hash array fed to this function MUST be filled with zeros initially, or the hashing will not work correctly. The startPage parameter refers to the first page to be hashed. The endPage parameter does not refer to the last page to be hashed, but to the first page to NOT hash.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">key</td><td>Pointer to 32-byte array containing the AES-256 key. </td></tr>
    <tr><td class="paramname">startPage</td><td>Starting 256-byte page of memory to hash (this page WILL be hashed) </td></tr>
    <tr><td class="paramname">endPage</td><td>Ending 256-byte page of memory to hash (this page will NOT be hashed) </td></tr>
    <tr><td class="paramname">hash</td><td>Pointer to a 16-byte hash array. Must be initialized to all zeros. </td></tr>
    <tr><td class="paramname">EEFlag</td><td>Flag to indicate memory type. 0 - Flash; 1 - EEPROM </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a10ff4a55a184a56510f959b90ddb74e4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a10ff4a55a184a56510f959b90ddb74e4">&#9670;&nbsp;</a></span>configure()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void configure </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Interfaces with host configure tool. </p>
<p>The procedure followed is outlined below.</p>
<p>1 - The routine waits to receive an ACK from the configure tool.</p>
<p>2 - The bootloader now calculates the hash of the bootloader in memory.</p>
<p>3 - The hash is now sent to the tools over UART1. </p><pre class="fragment">IF   CORRECT - The bootloader proceeds to check the EEPROM installation

IF INCORRECT - The bootloader sets a flag and terminates
</pre><p>3 - The routine waits for an ACK from the host tools.</p>
<p>4 - The hash of the EEPROM is now calculated.</p>
<p>5 - That hash is sent over UART1 to the host tools. </p><pre class="fragment">IF   CORRECT - The bootloader terminates.

IF INCORRECT - A flag is set and the bootloader terminates.</pre><p>The procedure followed is outlined below.</p>
<p>1 - The routine waits to receive an ACK from the configure tool. 2 - The bootloader now calculates the hash of the bootloader in memory. 3 - The hash is now sent to the tools over UART1. IF CORRECT - The bootloader proceeds to check the EEPROM installation IF INCORRECT - The bootloader sets a flag and terminates 3 - The routine waits for an ACK from the host tools. 4 - The hash of the EEPROM is now calculated. 5 - That hash is sent over UART1 to the host tools. IF CORRECT - The bootloader terminates. IF INCORRECT - A flag is set and the bootloader terminates. </p>

</div>
</div>
<a id="a86b1b361f8d4d2fe6b8b428feba54867"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a86b1b361f8d4d2fe6b8b428feba54867">&#9670;&nbsp;</a></span>disableClockSwitching()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void disableClockSwitching </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Stops Timer0, disabling Clock Switching. </p>

</div>
</div>
<a id="a3196fd27b969056c23b17850d0839e85"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3196fd27b969056c23b17850d0839e85">&#9670;&nbsp;</a></span>enableClockSwitching()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void enableClockSwitching </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Starts Timer0, enabling Clock Switching. </p>

</div>
</div>
<a id="ab7210aaba738ad94e5fd964a5570cee6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab7210aaba738ad94e5fd964a5570cee6">&#9670;&nbsp;</a></span>initTimer0()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void initTimer0 </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize Timer0 for clock switching. </p>

</div>
</div>
<a id="a9401b6b502308eaaa5813082af1c3046"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9401b6b502308eaaa5813082af1c3046">&#9670;&nbsp;</a></span>load_firmware()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void load_firmware </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Loads a new firmware image and release message. </p>
<p>This function securely loads a new firmware image onto flash. Firmware is encrypted using AES-256 in CFB Mode, and sent one page at a time. It is in the following format:</p>
<p>-----&mdash;32000 Bytes-----&mdash; -&mdash;256 Bytes--&mdash;</p>
<p>[Encrypted Firmware Update] [Message MAC Page]</p>
<p>The Encrypted Firmware Update section is broken into the following pages:</p>
<p>&ndash;256 Bytes&mdash; &ndash;30720 Bytes&mdash; &ndash;1024 Bytes&mdash;</p>
<p>[Version Page] [Firmware Pages] [Message Pages]</p>
<p>The version page is constructed in the following format:</p>
<p>--&mdash;2 Bytes-&mdash; &mdash;254 Bytes-&mdash;</p>
<p>[Version Number] [Random Padding]</p>
<p>Each Firmware Page consists of 256 bytes of raw flash. These are obtained via the PC stripping the .hex file generated from the firmware Makefile. Address offsets are added, and blank Flash in the Application Section will be written to 0xFF.</p>
<p>The Message Page is 1024 bytes input by the user at FW_PROTECT time. The string is null terminated, and empty bytes in the Message Section will be written to 0xFF</p>
<p>The Message MAC page is constructed in the following format:</p>
<p>&ndash;16 Bytes&mdash; &mdash;240 Bytes-&mdash;</p>
<p>[Message MAC] [Random Padding]</p>
<p>The procedure followed is outlined below.</p>
<p>1 - The encrypted firmware image is loaded into the ENCRYPTED_SECTION of flash.</p>
<p>2 - The CBC-MAC of the encrypted firmware image is computed, and compared to the CBC-MAC sent.</p>
<p>IF CORRECT - The bootloader proceeds with the firmware upload.</p>
<p>IF INCORRECT - The bootloader erases ENCRYPTED_SECTION and terminates.</p>
<p>3 - The firmware image is decrypted and stored in the DECRYPTED_SECTION of flash.</p>
<p>4 - The version number is checked versus the current version, and updated in EEPROM </p><pre class="fragment">IF   CORRECT - The bootloader proceeds with the firmware upload.

IF INCORRECT - The bootloader erases ENCRYPTED_SECTION and DECRYPTED_SECTION and
               terminate.
</pre><p>5 - The release message is written to the MESSAGE_SECTION</p>
<p>6 - The firmware is written to the APPLICATION_SECTION</p>
<p>7 - The bootloader erases ENCRYPTED_SECTION and DECRYPTED_SECTION and terminates</p>
<p>This function securely loads a new firmware image onto flash. Firmware is encrypted using AES-256 in CFB Mode, and sent one page at a time. It is in the following format:</p>
<p>-----&mdash;32000 Bytes-----&mdash; -&mdash;256 Bytes--&mdash; [Encrypted Firmware Update] [Message MAC Page]</p>
<p>The Encrypted Firmware Update section is broken into the following pages:</p>
<p>&ndash;256 Bytes&mdash; &ndash;30720 Bytes&mdash; &ndash;1024 Bytes&mdash; [Version Page] [Firmware Pages] [Message Pages]</p>
<p>The version page is constructed in the following format:</p>
<p>--&mdash;2 Bytes-&mdash; &mdash;254 Bytes-&mdash; [Version Number] [Random Padding]</p>
<p>Each Firmware Page consists of 256 bytes of raw flash. These are obtained via the PC stripping the .hex file generated from the firmware Makefile. Address offsets are added, and blank Flash in the Application Section will be written to 0xFF.</p>
<p>The Message Page is 1024 bytes input by the user at FW_PROTECT time. The string is null terminated, and empty bytes in the Message Section will be written to 0xFF</p>
<p>The Message MAC page is constructed in the following format:</p>
<p>&ndash;16 Bytes&mdash; &mdash;240 Bytes-&mdash; [Message MAC] [Random Padding]</p>
<p>The procedure followed is outlined below.</p>
<p>1 - The encrypted firmware image is loaded into the ENCRYPTED_SECTION of flash. 2 - The CBC-MAC of the encrypted firmware image is computed, and compared to the CBC-MAC sent. IF CORRECT - The bootloader proceeds with the firmware upload. IF INCORRECT - The bootloader erases ENCRYPTED_SECTION and terminates. 3 - The firmware image is decrypted and stored in the DECRYPTED_SECTION of flash. 4 - The version number is checked versus the current version, and updated in EEPROM IF CORRECT - The bootloader proceeds with the firmware upload. IF INCORRECT - The bootloader erases ENCRYPTED_SECTION and DECRYPTED_SECTION and terminate. 5 - The release message is written to the MESSAGE_SECTION 6 - The firmware is written to the APPLICATION_SECTION 7 - The bootloader erases ENCRYPTED_SECTION and DECRYPTED_SECTION and terminates </p>

</div>
</div>
<a id="a840291bc02cba5474a4cb46a9b9566fe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a840291bc02cba5474a4cb46a9b9566fe">&#9670;&nbsp;</a></span>main()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int main </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a2695b90a2a64b6fe11e14c1e2d13f26f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2695b90a2a64b6fe11e14c1e2d13f26f">&#9670;&nbsp;</a></span>program_flash()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void program_flash </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>page_address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&#160;</td>
          <td class="paramname"><em>data</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Programs a page of ATMega1284P flash memory. </p>
<p>To program flash, you need to access and program it in pages On the atmega1284p, each page is 128 words, or 256 bytes</p>
<p>Programing involves four things,</p><ol type="1">
<li>Erasing the page</li>
<li>Filling a page buffer</li>
<li>Writing a page</li>
<li>When you are done programming all of your pages, enable the flash</li>
</ol>
<p>You must fill the buffer one word at a time</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">page_address</td><td>Starting address of page to be programmed </td></tr>
    <tr><td class="paramname">data</td><td>256-byte array of data to be programmed </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="a5d4adc248ad2605b7c045108c6a48b1b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5d4adc248ad2605b7c045108c6a48b1b">&#9670;&nbsp;</a></span>readback()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void readback </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Interfaces with host readback tool. </p>
<p>This function allows the factory to read back sections of Application Flash. The tool DOES NOT read from EEPROM or Bootloader Flash. The 48-byte readback request is sent in the following format:</p>
<p>--&mdash;32 Bytes---&mdash; ---&mdash;_16 Bytes----&mdash;</p>
<p>[Encrypted Request] [Readback Request MAC]</p>
<p>The Encrypted Request encrypted using AES-256 in CFB mode, with a specific Readback Key and Readback Initialization Vector. It is in the following format:</p>
<p>---&mdash;24 Bytes--&mdash; -&mdash;4 Bytes-&mdash; &mdash;4 Bytes&mdash;</p>
<p>[Readback Password] [Start Address] [End Address]</p>
<p>Although the addresses are byte-addressable, this function will dump flash pages (each of which is 256 bytes). The function will begin returning the page containing the starting address, and finish returning the page returning the ending address. Each page is encrypted using the same key and IV and sent back to the PC.</p>
<p>The procedure followed is outlined below.</p>
<p>1 - The encrypted readback request is received</p>
<p>2 - The CBC-MAC of the encrypted readback request is calculated, and compared to the CBC-MAC sent.</p>
<p>IF CORRECT - The bootloader proceeds with the Readback Request</p>
<p>IF INCORRECT - The bootloader terminates</p>
<p>3 - The readback request is decrypted using the Readback Key and IV</p>
<p>4 - The readback password is checked versus the password stored in the bootloader </p><pre class="fragment">IF   CORRECT - The bootloader proceeds with the readback request

IF INCORRECT - The bootloader terminates
</pre><p>5 - The bootloader reads in the start address and end address and converts them to start page and end page. The end page is truncated to the page before the BOOTLOADER_SECTION.</p>
<p>6 - The bootloader begins reading the flash data a page at a time. Each page is encrypted using AES-256 in CFB mode using the Readback Key and IV before being sent to PC.</p>
<p>This function allows the factory to read back sections of Application Flash. The tool DOES NOT read from EEPROM or Bootloader Flash. The 48-byte readback request is sent in the following format:</p>
<p>--&mdash;32 Bytes---&mdash; ---&mdash;_16 Bytes----&mdash; [Encrypted Request] [Readback Request MAC]</p>
<p>The Encrypted Request encrypted using AES-256 in CFB mode, with a specific Readback Key and Readback Initialization Vector. It is in the following format:</p>
<p>---&mdash;24 Bytes--&mdash; -&mdash;4 Bytes-&mdash; &mdash;4 Bytes&mdash; [Readback Password] [Start Address] [End Address]</p>
<p>Although the addresses are byte-addressable, this function will dump flash pages (each of which is 256 bytes). The function will begin returning the page containing the starting address, and finish returning the page returning the ending address. Each page is encrypted using the same key and IV and sent back to the PC.</p>
<p>The procedure followed is outlined below.</p>
<p>1 - The encrypted readback request is received 2 - The CBC-MAC of the encrypted readback request is calculated, and compared to the CBC-MAC sent. IF CORRECT - The bootloader proceeds with the Readback Request IF INCORRECT - The bootloader terminates 3 - The readback request is decrypted using the Readback Key and IV 4 - The readback password is checked versus the password stored in the bootloader IF CORRECT - The bootloader proceeds with the readback request IF INCORRECT - The bootloader terminates 5 - The bootloader reads in the start address and end address and converts them to start page and end page. The end page is truncated to the page before the BOOTLOADER_SECTION. 6 - The bootloader begins reading the flash data a page at a time. Each page is encrypted using AES-256 in CFB mode using the Readback Key and IV before being sent to PC. </p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a4710eb249c76fbcee86e3b3ea93f7ea7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4710eb249c76fbcee86e3b3ea93f7ea7">&#9670;&nbsp;</a></span>EEMEM</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t fw_version EEMEM = 1</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ac23353dfc159499579eee2c03444f504"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac23353dfc159499579eee2c03444f504">&#9670;&nbsp;</a></span>firmwareIV</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t firmwareIV[<a class="el" href="bootloader_2main_8c.html#ad51ded0bbd705f02f73fc60c0b721ced">BLOCK_SIZE</a>] = FW_IV</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a3604d93cc7032be26dcca6e694afef50"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3604d93cc7032be26dcca6e694afef50">&#9670;&nbsp;</a></span>firmwareKey</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t firmwareKey[<a class="el" href="bootloader_2main_8c.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>] = FW_KEY</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a1c67bcd43e103c8093bb6036690ab2e3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1c67bcd43e103c8093bb6036690ab2e3">&#9670;&nbsp;</a></span>hashKey</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t hashKey[<a class="el" href="bootloader_2main_8c.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>] = H_KEY</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a36bf49f5e29276a4e9e96bf39a621f80"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a36bf49f5e29276a4e9e96bf39a621f80">&#9670;&nbsp;</a></span>readbackHashKey</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t readbackHashKey[<a class="el" href="bootloader_2main_8c.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>] = RBH_KEY</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a1b8a8d208ede5763090cb2498cb954de"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1b8a8d208ede5763090cb2498cb954de">&#9670;&nbsp;</a></span>readbackIV</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t readbackIV[<a class="el" href="bootloader_2main_8c.html#ad51ded0bbd705f02f73fc60c0b721ced">BLOCK_SIZE</a>] = RB_IV</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ab712a58833cf27f708f308e3e491a3e7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab712a58833cf27f708f308e3e491a3e7">&#9670;&nbsp;</a></span>readbackKey</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t readbackKey[<a class="el" href="bootloader_2main_8c.html#a2d996237e082b78b41771b5aa1a6eae1">KEY_SIZE</a>] = RB_KEY</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a68fe00d921fd371e6ed4b5e5c9350fd6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a68fe00d921fd371e6ed4b5e5c9350fd6">&#9670;&nbsp;</a></span>readbackPassword</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t readbackPassword[<a class="el" href="bootloader_2main_8c.html#a6bfdf0e01e9d3de942e38ba284d8ada3">READBACK_PASSWORD_SIZE</a>] = RB_PW</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Mar 2 2017 12:26:20 for UConn Mitre eCTF by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
